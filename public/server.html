<html>
<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha512-NhSC1YmyruXifcj/KFRWoC561YpHpc5Jtzgvbuzx5VozKpWvQ+4nXhPdFgmx8xqexRcpAglTj9sIBWINXa8x5w==" crossorigin="anonymous" referrerpolicy="no-referrer" /><!-- pragma: allowlist secret -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js" integrity="sha512-FHsFVKQ/T1KWJDGSbrUhTJyS1ph3eRrxI228ND0EGaEp6v4a/vGwPWd3Dtd/+9cI7ccofZvl/wulICEurHN1pg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- pragma: allowlist secret -->
  <link rel="stylesheet" href="/docs/server/assets/style.css"/>
  <link rel="stylesheet" href="/docs/server/assets/highlight.css"/>
</head>
<body>
<div class='docs-subheader'>
  <span class='code-snippet'>./docs/build.sh</span> # to regenerate
</div>
<div id='output' style='padding: 10px'>
<div class='container container-main'>
  <div class="col-content">
  </div>
  <div class='col-sidebar'>
    <div class='site-menu'>
      <ul class='tsd-small-nested-navigation' style='font-size: 20px;'></ul>
    </div>
  </div>
</div>
<script>

init()


// const flatByName = {}
// const flatById = {}
// const output = d3.select('#output')
//  d3.select('.tsd-page-title')

async function init() {
  // const data = await fetch('/docs/server.json')
  //   .then(r=>r.json())
  //   .catch(console.error)

  // console.log(data)
  // flatten(data.children)
  // console.log(flatById)
  // console.log(flatByName)
  // const value = getType("HealthCheckResponse")
  // d3.select('#output').text(JSON.stringify(value, null, '  '))

  const routes = [
    {
      endpoint: '/healthcheck',
      request: {
        type: {},
      },
      response: {
        type: "HealthCheckResponse"
      }
    }
  ]
  const sidebarLinks = d3.select('.tsd-small-nested-navigation')
  const contentDiv = d3.select('.col-content')

  for(const r of routes) {
    const section = contentDiv.append('div')
    const title = r.response.type
    sidebarLinks.append('li').append('a').attr('href', `#${title}`).html(r.endpoint)
    const url = `/docs/server/types/${title}.html`
    fetch(url)
      .then(d => d.text())
      .then(text => {
        const extract = extractSection(text)
        section.append('h2')
          .attr('id', r.endpoint)
          .attr('class', 'tsd-page-title')
          .style('cursor', 'pointer')
          .html(r.endpoint) 
          .on('click', ()=>{window.location = url})

        section.append('h3').html('Request')
        section.append('div').attr('class', 'tsd-signature').append('pre').html(JSON.stringify(r.request.type, null, '   '))

        section.append('h3').html('Response')
        const signature = section.append('div').html(extract)
        signature.selectAll('.tsd-kind-type-alias').attr('href', `#${title}`).on('click', mayExpand)
      })
      .catch(console.error)
  }
}

function extractSection(text) {
  const i = text.indexOf(`<div class="tsd-signature">`)
  const j = text.indexOf('</div>', i)
  return text.slice(i, j + 6).replaceAll(';', '').replaceAll('&nbsp;&nbsp;&nbsp;&nbsp;', '&nbsp;&nbsp;')
}
// must track the extracted and replaced DOM elements by DOM node;
// tracking the string keys may not be unique if the same type ID is used
// in multiple levels of a type declaration
const extracted = new WeakMap()
async function mayExpand(event) {
  const title = this.innerHTML
  const key = this;
  if (!extracted.has(key)) {
    const url = `/docs/server/types/${title}.html`
    await fetch(url)
      .then(d => d.text())
      .then(text => {
        const extract = extractSection(text).replace(`${title}:`, '')
        const div = document.createElement('div')
        d3.select(div).style('display', 'inline-block').style('vertical-align', 'top').html(extract)
        const obj = {div, parentNode: this.parentNode, title, orig: this,  extract, expanded: false}
        extracted.set(key, obj)
        //extracted.set(div)
      })
  }
  const x = extracted.get(key)
  if (x.expanded) {
    x.parentNode.replaceChild(x.orig, x.div)
    x.expanded = false
  } else {
    x.parentNode.replaceChild(x.div, x.orig)
    x.expanded = true
    const signature = d3.select(x.div)
    const span = signature.select('.tsd-kind-type-alias')
    span.style('cursor', 'pointer').html(title)
    extracted.set(span.node(), x) 
    signature.selectAll('.tsd-signature').style('padding', 0).style('position', 'relative').style('top', 0).style('border', 'none')
    signature.selectAll('.tsd-kind-type-alias').attr('href', `#${title}`).on('click', mayExpand)
  }
  return false
}

function flatten(children) {
  for(const c of children) {
    if (!(c.id in flatById)) {
      flatById[c.id] = c
      flatByName[c.name] = c
      if (c.children) flatten(c.children)
    }
  }
}

function getType(name) {
  const d = flatByName[name]
  if (!d) throw `not found: '${name}'`

  if (d.children) {
    const obj = {}
    for(const c of d.children) {
      obj[c.name] = 'something'
    }
    return obj
  }
}

function getParams() {
  const params={}
  if (!window.location.search.length) return params
  window.location.search.substr(1).split("&").forEach(kv=>{
    const [key,value] = kv.split("=")
    params[key] = value
  })
  return params
}

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms))
}
</script>

<script src='/docs/nav.js'></script>
</body>
</html>
